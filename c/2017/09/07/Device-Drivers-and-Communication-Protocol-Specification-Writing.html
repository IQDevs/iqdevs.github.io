<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Device Drivers and Communication Protocol Specification Writing</title>
  <meta name="description" content="Device drivers and protocol design are two areas where one could get really technical and dive into very complex topics, though this guide doesn’t need to be...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/c/2017/09/07/Device-Drivers-and-Communication-Protocol-Specification-Writing.html">
  <link rel="alternate" type="application/rss+xml" title="IQDevs Blog" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">IQDevs Blog</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Device Drivers and Communication Protocol Specification Writing</h1>
    <p class="post-meta"><time datetime="2017-09-07T05:00:00+00:00" itemprop="datePublished">Sep 7, 2017</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">alkass</span></span></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Device drivers and protocol design are two areas where one could get really technical and dive into very complex topics, though this guide doesn’t need to be. We’re going to write a device driver that processes incomming commands and returns responses conforming to a standard specification that we’re going to write first.</p>

<p>What device are we targetting? We could design a USB device and write a Linux Kernel module, but that’d be too heaftly of a task for a single blog post, so instead, we’re going to stick a device that doesn’t require an OS or even a Kernel. I decided to go Arduino, but everything discussed here works just fine with ESP8266 or any boards that allow you to flash Arduino-compiled code.</p>

<h2 id="project-setup">Project Setup</h2>

<p>I’m also going to use <a href="http://platformio.org/">Platformio</a> to ease up the build and deployment process. If you don’t have <code class="highlighter-rouge">Platformio</code> installed, the following command should take care of that part for you:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>pip install platformio
</code></pre>
</div>

<blockquote>
  <p>The techniques discussed here are by no means Arduino-specific. They are applicable to any device with serial or any type of connection for that matter.</p>
</blockquote>

<p>Start a <code class="highlighter-rouge">Platformio</code> project as follows:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>mkdir my_device_driver <span class="o">&amp;&amp;</span> <span class="nb">cd </span>my_device_driver
<span class="gp">$ </span>pip init .
</code></pre>
</div>

<p>Add your board to the project:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c"># If you're adding an Arduino board run the following</span>
<span class="gp">$ </span>pio init --board XXX

<span class="c"># Or the following if you're adding an ESP8266 board</span>
<span class="gp">$ </span>pio init --board YYY
</code></pre>
</div>

<p>Add a source file to your project:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>touch src/main.ino
</code></pre>
</div>

<p>Open <code class="highlighter-rouge">src/main.ino</code> in your preferred code editor and add the following lines of code to it:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Hello, Device Driver!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Now build your code and make sure everything completes successfully:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>pio build
</code></pre>
</div>

<p>Connect your board to your computer over a USB cable and run the following command:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>pio run --target upload
</code></pre>
</div>

<blockquote>
  <p>The command above may fail due to lack of permission to access the device files. If you happen to be following along on a <code class="highlighter-rouge">Linux</code> machine (which is what I’d highly recommend), the following should fix your problem:</p>
</blockquote>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>sudo pio run --target upload
</code></pre>
</div>

<p>Now if you run the following:</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>pio device monitor <span class="c"># Or sudo pio device monitor</span>
</code></pre>
</div>

<p>You should be seeing an endless stream of the “Hello, Device Driver!” string. This is a clear indicator that everything (project setup, build chain, USB connection, and serial communication) is good to go.</p>

<h2 id="specification-writing">Specification Writing</h2>
<p>Now onto designing our communication protocol specification. Specification documents are written to outline what needs to be done (HLD - short for High-Level Design) in all cases, <b>and how it has to be done</b> (LLD - short for Low-Level Design) in some cases.
Our specification will cover both the HLD and the LLD sides of the project.</p>

<h3 id="hld">HLD</h3>
<p>What would you like your device to do? This is the type of question an HLD can answer. Since I’m the one writing this blog post, I have decided to stick to writing the shortest specification possible. We’re going to allow the control of all digital and analog pins remotely. This can be formly written as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>The device driver will allow serial access to all input and output pins (both analog and digital) on the following boards:
* ESP8266
* Arduino Uno
* Arduino Mega
* Arduino Duemilanove
</code></pre>
</div>

<h3 id="lld">LLD</h3>
<p>Now that we’ve defined our expected bevaiour in our HLD, we can go ahead and decide how to go about having it all done. This is where LLD comes into place.</p>

<p>We’ve decided that our end goal is to allow access to all pins over serial. We know the best way to maniuplate the pins is to use these functions: <code class="highlighter-rouge">pinMode</code>, <code class="highlighter-rouge">digitalRead</code>, <code class="highlighter-rouge">analogRead</code>, <code class="highlighter-rouge">digitalWrite</code>, and <code class="highlighter-rouge">analogWrite</code>. So, we can write our LLD specification to limt our use of the pins to these five functions only. This could be formly done as so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>All pin manipulation must be limitted to using `pinMode`, `digitalRead`, `analogRead`, `digitalWrite`, and `analogWrite`. No bit togolling is allowed.
</code></pre>
</div>

<p>Now let’s talk a little about our inputs (requests) and outputs (responses).</p>

<p>Every command we send to or recieve from the board MUST start with an agreed-upon hard-coded acknowledgment byte. The purpose of having this byte it so make sure we have a valid command to work with. If, for instance, your last command read less or more bytes that it was supposed to, all upcoming commands coming from thatpoint onward will be messed up. Not having the expeceted acknowledgment byte in place will draw our attention to a stagerring bug if the boards misbehaviour is, for any reason, not obvious. Because 0 is the natural result you get when you zero out a block of memory, making our acknowledgment zero will make our deiver implementation prone to all sorts of defects. So, we could specifically prohibit the use of zero as a valid acknowledgment byte:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Every request sent to the board and every response retrieved from the board must start with an agreed-upon hard-coded acknowledgment byte. For the same of conformity, we have decided that our acknowledgment byte is 0xA.
</code></pre>
</div>

<p>To achieve a smooth experience, we need to decide on an upper byte limit for both requests and responses, that way we don’t have to calculate offsets on the fly which will require more processing power. For something as little as an Arduino board, you definitely need to consider solutions that require as little memory and processing power as possible. If you do the math correctly, you’ll need one byte for your <code class="highlighter-rouge">acknolwdgment</code> field, one for the <code class="highlighter-rouge">id</code>, one for the <code class="highlighter-rouge">pin</code>, one for the <code class="highlighter-rouge">type</code> of the pin, one for the <code class="highlighter-rouge">mode</code> (in the case of setting a pin mode), and one for the <code class="highlighter-rouge">value</code> (in the case of setting a pin value). Since <code class="highlighter-rouge">mode</code> and <code class="highlighter-rouge">value</code> can’t coexist, we can safely assume that the maximum size needed for each command is 5 bytes.</p>

<h2 id="driver-implementation">Driver Implementation</h2>


  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">IQDevs Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              IQDevs Blog
            
            </li>
            
            <li><a href="mailto:ceo@skaykeapp.com">ceo@skaykeapp.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/IQDevs"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">IQDevs</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Some things are too good to contain in a little box</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
